(()=>{"use strict";window.util={offerTypes:{flat:{minPrice:"1000",text:"Квартира"},house:{minPrice:"5000",text:"Дом"},palace:{minPrice:"10000",text:"Дворец"},bungalow:{minPrice:"0",text:"Бунгало"}},onPrimaryMouseButtonPress:(e,t)=>{0===e.button&&t()},onEscPress:(e,t)=>{"Escape"===e.key&&t()},onEnterPress:(e,t)=>{"Enter"===e.key&&t()}},(()=>{const e=(e,t,o,r,n)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case 200:r(i.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e=`Cтатус ответа: ${i.status} ${i.statusText}`}e&&n(e)})),i.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.timeout=4e3,i.open(e,t),o?i.send(o):i.send()};window.server={load:(t,o)=>{e("GET","https://21.javascript.pages.academy/keksobooking/data",null,t,o)},upload:(t,o,r)=>{e("POST"," https://21.javascript.pages.academy/keksobooking",t,o,r)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),r=o.querySelector(".error__button"),n=()=>{i(),c()},i=()=>{const e=document.querySelector(".success"),t=document.querySelector(".error");e?e.remove():t&&t.remove()},s=e=>{window.util.onEscPress(e,n)},a=()=>{document.addEventListener("keydown",s),document.addEventListener("click",n)},c=()=>{document.removeEventListener("keydown",s),document.removeEventListener("click",n)};window.message={errorHandler:e=>{const t=document.createElement("div");t.style="z-index: 100; padding: 10px; margin: 0 auto; color: #fff; font-weight: 500; text-align: center; background-color: #f44336; border-radius: 4px;",t.style.position="fixed",t.style.top="5px",t.style.left="15px",t.style.right="15px",t.style.fontSize="30px",t.textContent=e,t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",o);const o=e=>{window.util.onEscPress(e,t.remove())};document.body.insertAdjacentElement("afterbegin",t),window.form.filters.remove()},error:()=>{e.insertAdjacentElement("afterbegin",o),r.addEventListener("click",(()=>{o.remove()})),a()},success:()=>{e.insertAdjacentElement("afterbegin",t),a()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview"),r=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form__photo"),i=(e,t,o)=>({text:e,size:{width:t,height:o}}),s=i("Аватар пользователя",40,44),a=i("Фотография жилья",70,70),c=(e,t,o)=>{const r=document.createElement("img");r.src=e,r.width=t.size.width,r.height=t.size.height,r.alt=t.text,o.appendChild(r)},d=(t,o,r)=>{t.addEventListener("change",(()=>{const n=t.files[0],i=n.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.innerHTML="",c(e.result,r,o)})),e.readAsDataURL(n)}}))};d(t,o,s),d(r,n,a),window.photo={resetPreviews:()=>{n.innerHTML="",o.innerHTML="",c("img/muffin-grey.svg",s,o)}}})(),(()=>{const e=document.querySelector(".map");window.map={disable:()=>{e.classList.add("map--faded")},enable:()=>{e.classList.remove("map--faded")}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=t.offsetHeight+10,r=Math.floor(t.offsetWidth/2);let n={min:0-r,max:e.offsetWidth-r},i={min:130-o,max:630-o};t.addEventListener("mousedown",(e=>{e.preventDefault();let r=!1,a={X:e.clientX,Y:e.clientY};const c=e=>{e.preventDefault(),window.card.close(),window.pin.disable(),t.removeEventListener("keydown",s),r=!0;const c=a.X-e.clientX,d=a.Y-e.clientY;a={X:e.clientX,Y:e.clientY};let l=t.offsetTop-d,u=t.offsetLeft-c;u<=n.min?u=n.min:u>=n.max&&(u=n.max),l<=i.min?l=i.min:l>=i.max&&(l=i.max),t.style.top=l+"px",t.style.left=u+"px",window.form.fillAddress(t,o)},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d);const n=e=>{e.preventDefault(),t.removeEventListener("click",n)};!1===r&&t.addEventListener("click",n),window.form.fillAddress(t,o)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)}));const s=e=>{window.util.onEnterPress(e,window.main.activatePage)};window.mainPin={restart:()=>{t.style.top="375px",t.style.left="570px",window.form.fillAddress(t,o),t.addEventListener("keydown",s)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o=e.querySelector(".map__filters-container"),r=()=>{const e=document.querySelector(".map__card");e&&e.remove()},n=()=>{r(),document.removeEventListener("keydown",i)},i=e=>{"Escape"===e.key&&(e.preventDefault(),n())};window.card={get:e=>{let o=t.cloneNode(!0);const r=o.querySelector(".popup__photos"),n=r.querySelector(".popup__photo"),i=o.querySelector(".popup__features"),s=o.querySelector(".popup__close");return o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",o.querySelector(".popup__text--capacity").textContent=((e,t)=>{let o="";return o=0===e?"Помещение ":e%10==1&&e%100!=11?e+" комната ":e%10>1&&e%10<5&&e%100!=12&&e%100!=13&&e%100!=14?e+" комнаты ":e+" комнат ",o+=0===t?"без гостей":t%10==1&&t%100!=11?"для "+t+" гостя.":"для "+t+" гостей.",o})(e.offer.rooms,e.offer.guests),o.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,o.querySelector(".popup__description").textContent=e.offer.description,o.querySelector(".popup__avatar").src=e.author.avatar,o.querySelector(".popup__type").textContent=window.util.offerTypes[e.offer.type].text,e.offer.photos?(r.innerHTML="",e.offer.photos.forEach((e=>{const t=n.cloneNode(!0);t.src=e,r.append(t)}))):r.remove(),e.offer.features?(i.innerHTML="",e.offer.features.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),i.append(t)}))):i.remove(),s.addEventListener("click",(()=>{o.remove(),window.pin.disable()})),o},create:t=>{r(),document.addEventListener("keydown",i),e.insertBefore(t,o)},close:n}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),s=t.querySelector("#housing-features"),a=t=>{switch(r.value){case e:return!0;case"low":return t.offer.price<1e4;case"middle":return t.offer.price>=1e4&&t.offer.price<5e4;case"high":return t.offer.price>=5e4;default:return t===r.value}};window.filter={doOffers:t=>{const r=[];for(let c=0;c<t.length;c++){const d=t[c],l=o.value===e||d.offer.type===o.value,u=n.value===e||d.offer.rooms===+n.value,m=i.value===e||d.offer.guests===+i.value,p=a(d),f=Array.from(s.querySelectorAll("input:checked")).map((e=>e.value)).every((e=>d.offer.features.includes(e)));if(l&&u&&m&&p&&f&&r.push(d),5===r.length)break}return r}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=document.querySelectorAll("fieldset"),r=document.querySelector(".map__filters"),n=t=>{if(!t.offer)return!1;const o=e.cloneNode(!0),r=o.querySelector("img");return o.style=`left: ${t.location.x-r.width/2}px;top: ${t.location.y-r.height}px;`,r.src=t.author.avatar,r.alt=t.offer.title,o.addEventListener("click",(()=>{window.card.create(window.card.get(t)),s(),o.classList.add("map__pin--active"),document.addEventListener("keydown",a)})),o},i=e=>{const t=document.createDocumentFragment();let o;o=e.length<5?e.length:5;for(let r=0;r<o;r++)t.appendChild(n(e[r]));document.querySelector(".map__pins").appendChild(t)},s=()=>{const e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")},a=e=>{"Escape"===e.key&&(e.preventDefault(),s())},c=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};let d=[];const l=e=>{d=e,e.length>0&&window.form.enableItems(o),u()},u=()=>{c(),window.card.close();const e=window.filter.doOffers(d);i(e)};r.addEventListener("change",window.debounce(u)),window.pin={disable:s,insert:i,remove:c,update:()=>{window.server.load(l,window.message.errorHandler)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters"),o=e.querySelector("#address"),r=e.querySelector("#room_number"),n=e.querySelector("#capacity"),i=e.querySelector("#price"),s=e.querySelector("#type"),a=e.querySelector("#timein"),c=e.querySelector("#timeout"),d=e.querySelector(".ad-form__reset"),l={1:"1 комната — для 1 гостя",2:"2 комнаты — для 2 гостей или для 1 гостя",3:"3 комнаты — для 3 гостей, или для 2 гостей, или для 1 гостя",100:"100 комнат — не для гостей"},u=()=>{i.setAttribute("min",window.util.offerTypes[s.value].minPrice),i.setAttribute("placeholder",window.util.offerTypes[s.value].minPrice)},m=()=>{const e=+n.value,t=+r.value;let o=!0;return 100===t&&0!==e||100!==t&&(e<1||e>t)?(n.setCustomValidity(l[t]),o=!1):n.setCustomValidity(""),n.reportValidity(),o},p=e=>{const t=e.target;t===a?c.value=a.value:t===c&&(a.value=c.value)},f=()=>{u(),s.addEventListener("input",u),m(),r.addEventListener("change",m),n.addEventListener("change",m),a.addEventListener("change",p),c.addEventListener("change",p)},w=()=>{e.reset(),t.reset(),u(),window.message.success(),window.main.deactivatePage()},y=()=>{window.message.error()};e.addEventListener("submit",(t=>{t.preventDefault(),window.server.upload(new FormData(e),w,y),window.scrollTo(0,0)})),d.addEventListener("click",(()=>{e.reset(),t.reset(),f(),window.main.deactivatePage(),window.scrollTo(0,0)})),window.form={filters:t,checkValidation:f,disableItems:e=>{e.forEach((e=>{e.setAttribute("disabled",!0)}))},enableItems:e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},fillAddress:(t,r)=>{let n,i=Math.floor(parseInt(t.style.left,10)+t.clientWidth/2);n=e.classList.contains("ad-form--disabled")?Math.floor(parseInt(t.style.top,10)+t.clientHeight/2):Math.floor(parseInt(t.style.top,10)+r),o.value=`${i}, ${n}`}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),o=document.querySelectorAll("fieldset"),r=()=>{e.removeEventListener("mousedown",i),e.removeEventListener("keydown",s)},n=()=>{e.addEventListener("mousedown",i),e.addEventListener("keydown",s)},i=e=>{window.util.onPrimaryMouseButtonPress(e,c),r()},s=e=>{window.util.onEnterPress(e,c),r()};n();const a=()=>{window.map.disable(),window.form.disableItems(o),window.pin.remove(),window.card.close(),t.classList.add("ad-form--disabled"),window.mainPin.restart(),n(),window.photo.resetPreviews()};a(),window.form.checkValidation();const c=()=>{window.map.enable(),window.form.enableItems(o),t.classList.remove("ad-form--disabled"),window.pin.update()};window.main={deactivatePage:a,activatePage:c}})()})();